#!/usr/bin/env sh

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "   PRE-COMMIT VALIDATIONS - TestForge"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 1. TYPE CHECKING (TypeScript)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ [1/4] Verificando tipos TypeScript..."
npm run type-check
if [ $? -ne 0 ]; then
  echo ""
  echo "โ Error: Type-check fallo. Corrige los errores de TypeScript antes de hacer commit."
  echo ""
  exit 1
fi
echo "โ Type-check paso correctamente"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 2. LINT-STAGED (ESLint + Prettier)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐งน [2/4] Ejecutando ESLint y Prettier en archivos staged..."
npx lint-staged
if [ $? -ne 0 ]; then
  echo ""
  echo "โ Error: Lint-staged fallo. Revisa los errores de linting/formato."
  echo ""
  exit 1
fi
echo "โ Lint y formato completados"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 3. BUILD CHECK
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐๏ธ  [3/4] Verificando que el proyecto compila..."
npm run build
if [ $? -ne 0 ]; then
  echo ""
  echo "โ Error: Build fallo. El proyecto debe compilar antes de hacer commit."
  echo ""
  exit 1
fi
echo "โ Build exitoso"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 4. AUTO-REVISION COMPLETA (6 categorias)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ [4/4] Ejecutando auto-revision completa del proyecto..."
echo ""

npm run auto-review
AUTO_REVIEW_EXIT=$?

if [ $AUTO_REVIEW_EXIT -ne 0 ]; then
  echo ""
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo "โ AUTO-REVISION FALLO - COMMIT BLOQUEADO"
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo ""
  echo "La auto-revision detecto problemas criticos que deben resolverse."
  echo ""
  echo "Opciones:"
  echo "  1. Corrige los issues reportados arriba"
  echo "  2. Ejecuta 'npm run auto-review' para ver el reporte completo"
  echo "  3. Revisa el reporte en docs/reviews/"
  echo ""
  echo "El commit NO se realizara hasta que se resuelvan los issues."
  echo ""
  exit 1
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ TODAS LAS VALIDACIONES PASARON"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "  โ TypeScript compila sin errores"
echo "  โ ESLint y Prettier aplicados"
echo "  โ Build exitoso"
echo "  โ Auto-revision: 6/6 categorias aprobadas"
echo ""
echo "Procediendo con el commit..."
echo ""
